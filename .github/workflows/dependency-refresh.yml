---
name: Dependency Refresh

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  refresh:
    name: Update Locks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@eb1897b8dc4b5d5bfe39a428a8f2304605e0983c  # v7.0.0

      - name: Refresh dependency locks
        run: |
          uv lock --upgrade
          uv export --format requirements-txt --frozen > requirements.txt

      - name: Record changes
        run: |
          git status --short
          git diff
        env:
          GIT_PAGER: cat

      - name: Create pull request
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f  # v7.0.5
        with:
          token: ${{ secrets.BOT_TOKEN }}
          branch: automation/dependency-refresh
          delete-branch: true
          commit-message: "chore: refresh dependency locks"
          title: "chore: refresh dependency locks"
          body: |
            Automated dependency refresh.

            - `uv lock --upgrade`
            - `uv export --format requirements-txt --frozen > requirements.txt`
          labels: dependencies
