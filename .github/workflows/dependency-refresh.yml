---
name: Dependency Refresh

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  refresh:
    name: Update Locks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244  # v7.1.4

      - name: Refresh dependency locks
        run: |
          uv lock --upgrade
          uv export --format requirements-txt --frozen > requirements.txt

      - name: Record changes
        run: |
          git status --short
          git diff
        env:
          GIT_PAGER: cat

      - name: Create pull request
        uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412  # v7.0.9
        with:
          token: ${{ secrets.BOT_TOKEN }}
          branch: automation/dependency-refresh
          delete-branch: true
          commit-message: "chore: refresh dependency locks"
          title: "chore: refresh dependency locks"
          body: |
            Automated dependency refresh.

            - `uv lock --upgrade`
            - `uv export --format requirements-txt --frozen > requirements.txt`
          labels: dependencies
