---
name: Sync Main to Develop

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force:
        description: 'Force sync even if not on main'
        required: false
        default: 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Sync Main to Develop
    runs-on: ubuntu-latest
    # Only run on main branch or manual workflow_dispatch with force=true
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.force == 'true')
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync main to develop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TRIGGER_EVENT: ${{ github.event_name }}
          MAIN_SHA: ${{ github.sha }}
        run: |
          echo "Syncing main to develop..."
          git fetch origin main:main
          git fetch origin develop:develop
          git checkout develop

          # Check if develop is behind main
          BEHIND=$(git rev-list --count develop..main)
          echo "Develop is $BEHIND commits behind main"

          if [ "$BEHIND" -eq 0 ]; then
            echo "✅ Develop is up to date with main"
            exit 0
          fi

          # Check if main is behind develop (history divergence)
          AHEAD=$(git rev-list --count main..develop)
          if [ "$AHEAD" -gt 0 ]; then
            echo "⚠️ Histories have diverged (develop is $AHEAD ahead, $BEHIND behind)"
            echo "This usually means history was rewritten. Skipping sync to avoid conflicts."
            echo "Please manually verify the branches are in the desired state."
            exit 0
          fi

          # Try to merge main into develop
          echo "Merging main into develop..."
          if git merge main --no-edit; then
            echo "✅ Successfully merged main into develop"
            git push origin develop
            echo "✅ Pushed to develop"
          else
            echo "❌ Merge conflict detected"
            git merge --abort

            # Create a PR instead
            echo "Creating PR to sync main → develop..."
            BRANCH_NAME="sync/main-to-develop-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH_NAME"
            git merge main --no-commit --no-ff || true

            # If there are conflicts, commit them
            git add .
            git commit -m "chore: sync main to develop" \
              -m "Automated sync from main branch. Please review and resolve any conflicts." \
              -m "Triggered by: ${TRIGGER_EVENT}" \
              -m "SHA: ${MAIN_SHA}" || true

            git push origin "$BRANCH_NAME"

            # Create PR with body using environment variables
            gh pr create \
              --base develop \
              --head "$BRANCH_NAME" \
              --title "chore: sync main to develop" \
              --body "## Summary

            Automated sync from main to develop branch.

            **Trigger**: ${TRIGGER_EVENT}
            **Main SHA**: ${MAIN_SHA}

            ### Review Notes
            - Check for any merge conflicts
            - Verify all changes are expected
            - Ensure CI passes before merging

            **Auto-generated by sync workflow**"

            echo "✅ Created PR for manual review"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Sync Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Trigger**: ${{ github.event_name }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Main SHA**: \`${{ github.sha }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Status**: Check job logs for details" >> "$GITHUB_STEP_SUMMARY"
