---
name: Cleanup Merged Branches

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no deletions)'
        required: false
        type: boolean
        default: true

jobs:
  cleanup:
    name: Delete Merged Branches
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-slim  # Lightweight runner: git commands and branch deletion
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete merged branch
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const base = context.payload.pull_request.base.ref;
            core.info(`PR merged: ${branch} -> ${base}`);

            if (branch === "main" || branch === "develop") {
              core.warning(`Skipping protected branch: ${branch}`);
              return;
            }

            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`,
              });
              core.info(`Deleted merged branch: ${branch}`);
            } catch (error) {
              if (error.status === 404 || error.status === 422) {
                core.warning(`Branch already deleted or not found: ${branch}`);
              } else {
                throw error;
              }
            }

      - name: Cleanup old merged branches
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "üîç Finding branches merged into main..."

          DRY_RUN="${{ inputs.dry_run }}"
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "üîç DRY RUN MODE - No branches will be deleted"
          fi

          # Get all remote branches merged into main
          git fetch origin main
          MERGED_BRANCHES=$(git branch -r --merged origin/main | \
            grep -v "origin/main" | \
            grep -v "origin/develop" | \
            grep -v "origin/HEAD" | \
            sed 's|origin/||' || true)

          if [ -z "$MERGED_BRANCHES" ]; then
            echo "‚úÖ No merged branches to clean up"
            exit 0
          fi

          echo ""
          echo "üìã Branches merged into main:"
          echo "$MERGED_BRANCHES"
          echo ""

          if [[ "$DRY_RUN" == "true" ]]; then
            COUNT=$(echo "$MERGED_BRANCHES" | wc -l)
            echo "Would delete $COUNT branches (dry run)"
            exit 0
          fi

          # Delete each merged branch
          echo "$MERGED_BRANCHES" | while read -r branch; do
            branch=$(echo "$branch" | xargs)  # trim whitespace
            if [ -n "$branch" ]; then
              echo "üóëÔ∏è  Deleting: $branch"
              git push origin --delete "$branch" || echo "‚ö†Ô∏è  Could not delete $branch"
            fi
          done

          echo ""
          echo "‚úÖ Cleanup complete"

      - name: Summary
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            core.summary.addHeading("Branch Cleanup Summary", 2).addBlankLine();

            if (context.eventName === "pull_request") {
              const branch = context.payload.pull_request.head.ref;
              const base = context.payload.pull_request.base.ref;
              core.summary.addList([
                "Trigger: PR merge",
                `Branch: \`${branch}\``,
                `Merged into: \`${base}\``,
              ]);
            } else {
              const dryRun = context.payload.inputs?.dry_run ?? "true";
              core.summary.addList([
                "Trigger: Manual workflow dispatch",
                `Dry run: ${dryRun}`,
              ]);
            }

            core.summary.addBlankLine();
            core.summary.addRaw("Check job logs for details");
            await core.summary.write();
