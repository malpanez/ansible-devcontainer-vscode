---
name: Promote develop to main

# This workflow automatically creates a PR from develop to main when changes are pushed to develop.
# It uses continue-on-error to handle cases where GitHub Actions doesn't have permission to create PRs.
#
# To enable full automation, go to:
# Settings → Actions → General → Workflow permissions
# Enable: "Allow GitHub Actions to create and approve pull requests"
#
# Without this setting, you can still manually create the PR and this workflow will attempt to enable auto-merge.

on:
  push:
    branches:
      - develop
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-promotion-pr:
    name: Create PR from develop to main
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_COUNT=$(gh pr list --base main --head develop --state open --json number --jq 'length')
          echo "pr_count=$PR_COUNT" >> "$GITHUB_OUTPUT"

      - name: Create promotion PR
        id: create-pr
        if: steps.check-pr.outputs.pr_count == '0'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base main \
            --head develop \
            --title "chore: promote develop to main" \
            --body "$(cat <<'EOF'
          ## Automated Promotion from develop to main

          This PR promotes the current `develop` branch to `main` after all tests have passed.

          ### What's included

          All changes merged to `develop` since the last promotion, including:
          - Feature additions
          - Bug fixes
          - Dependency updates
          - Documentation improvements

          ### Pre-merge checklist

          - [ ] All CI checks passing
          - [ ] No merge conflicts
          - [ ] Reviewed recent commits in develop

          ### Auto-merge

          This PR will automatically merge once all required checks pass.

          ---

          *This PR was created automatically by the promote-to-main workflow.*
          EOF
          )"

      - name: Wait for PR to be ready
        if: steps.check-pr.outputs.pr_count == '0' && steps.create-pr.outcome == 'success'
        run: sleep 5

      - name: Enable auto-merge on promotion PR
        if: always()
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the PR number (works whether we just created it or it already exists)
          PR_NUMBER=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            echo "Found PR #$PR_NUMBER from develop to main"
            # Enable auto-merge with squash strategy
            gh pr merge "$PR_NUMBER" --auto --squash || echo "Auto-merge might already be enabled or permissions insufficient"
          else
            echo "No open PR found from develop to main"
            exit 0
          fi
